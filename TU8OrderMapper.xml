<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
        "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="U8Order">
    <typeAlias alias="Order" type="com.ircloud.ydh.sdk4j.model.Order"/>
    <typeAlias alias="OrderDetail" type="com.ircloud.ydh.sdk4j.model.OrderDetail"/>

  	<sql id="Base_Columns">
		id,
		ivtid,
		cchanger,
		cbustype,
		ccrechpname,
		cstcode,
		ddate,
		csocode,
		ccuscode,
		cdepcode,
		cpersoncode,
		csccode,
		ccusoaddress,
		cpaycode,
		cexch_name,
		iexchrate,
		itaxrate,
		imoney,
		cmemo,
		istatus,
		cmaker,
		cverifier,
		ccloser,
		cdefine1,
		cdefine2,
		cdefine3,
		cdefine4,
		cdefine5,
		cdefine6,
		cdefine7,
		cdefine8,
		cdefine9,
		cdefine10,
		cdefine11,
		cdefine12,
		cdefine13,
		cdefine14,
		cdefine15,
		cdefine16,
		dpredatebt,
		dpremodatebt,
		bdisflag,
		clocker,
		ccusname,
		breturnflag,
		coppcode
	</sql>


	
	<sql id="Detail_Base_Columns">
        csocode,
		cinvcode,
		dpredate,
		iquantity,
		inum,
		iquotedprice,
		iunitprice,
		itaxunitprice,
		imoney,
		itax,
		isum,
		idiscount,
		inatunitprice,
		inatmoney,
		inattax,
		inatsum,
		inatdiscount,
		ifhnum,
		ifhquantity,
		ifhmoney,
		ikpquantity,
		ikpnum,
		ikpmoney,
		cmemo,
		cfree1,
		cfree2,
		isosid,
		kl,
		kl2,
		cinvname,
		itaxrate,
		cdefine22,
		cdefine23,
		cdefine24,
		cdefine25,
		cdefine26,
		cdefine27,
		citemcode,
		citem_class,
		citemname,
		citem_cname,
		cfree3,
		cfree4,
		cfree5,
		cfree6,
		cfree7,
		cfree8,
		cfree9,
		cfree10,
		iinvexchrate,
		cunitid,
		id,
		cdefine28,
		cdefine29,
		cdefine30,
		cdefine31,
		cdefine32,
		cdefine33,
		cdefine34,
		cdefine35,
		cdefine36,
		cdefine37,
		fpurquan,
		fsalecost,
		fsaleprice,
		cquocode,
		iquoid,
		cscloser,
		dpremodate,
		irowno,
		icusbomid,
		imoquantity,
		ccontractid,
		ccontracttagcode,
		ccontractrowguid,
		ippartseqid,
		ippartid,
		ippartqty,
		ccusinvcode,
		ccusinvname,
		iprekeepquantity,
		iprekeepnum,
		iprekeeptotquantity,
		iprekeeptotnum
	</sql>
  
    <insert id="saveOrder" parameterClass="Order">
		insert into SO_SOMain(<include refid="Base_Columns"/>)
        select
			(select top 1 max(maxorderid) from YDH_Max_OrderID where TableName = 'Somain'),
			95,
			Null,
			N'普通销售',
			Null,
			N'08',
			CONVERT(char,#createTime#,23),
			#orderNum#,
			#customer.code#,
			N'34',
			N'qx8899',
			Null,
			'收货人：'+#contact#+',联系电话：'+#mobile#+',收货地址：'+#area#+#address#,
			Null,
			N'人民币',
			1,
			17,
			Null,
			<isEmpty property="remarks">
				 <![CDATA[ '' ]]> 
			</isEmpty>
			<isNotEmpty property="remarks">
				 <iterate property="remarks"   conjunction="+" >
					#remarks[].content# + ' -- '
				 </iterate>
			</isNotEmpty>,
			Null,
			N'易订货',
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			N'智控事业部',
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			CONVERT(char,#deliveryDate#,23),
			CONVERT(char,#deliveryDate#,23),
			0,
			Null,
			(select ccusname from customer where cCusCode = #customer.code#),
			0,
			Null
	</insert>

    
 
    <insert id="saveOrderDetail" parameterClass="OrderDetail">
		insert into SO_SODetails(<include refid="Detail_Base_Columns"/>)
        select
			#orderNum#,
			(select cinvcode from inventory where cinvdefine5 = #productCode#),
			CONVERT(char,#createTime#,23),
			#count#,
			Null,
			0,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))/1.17 when $isGift$ = 1 then cast(#discountMoney#/#count# as numeric(28, 10))/1.17 end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8)) when $isGift$ = 1 then cast(#discountMoney#/#count# as numeric(28, 10)) end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))/1.17*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10))/1.17 end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))*(0.17/1.17)*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10))*(0.17/1.17) end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10)) end,
			0,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))/1.17 when $isGift$ = 1 then cast(#discountMoney#/#count# as numeric(28, 10))/1.17 end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))/1.17*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10))/1.17 end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))*(0.17/1.17)*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10))*(0.17/1.17) end,
			case when $isGift$ = 0 then cast(#price# as numeric(20, 8))*#count# when $isGift$ = 1 then cast(#discountMoney# as numeric(28, 10)) end,
			0,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			isnull((select max(isosid)+1  from SO_SODetails), 1),
			100,
			100,
			(select cinvname from Inventory where cinvcode = #productCode#),
			17,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			(select id from SO_SOMain where csocode = #orderNum#),
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			0,
			0,
			Null,
			Null,
			Null,
			CONVERT(char,#createTime#,23),
			isnull((select MAX(irowno)+1 from SO_SODetails where csocode = #orderNum#), 1),
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null,
			Null
    </insert>
 	
	<!-- 保存退货单 -->
 	<insert id="saveReturnOrder" parameterClass="Order">
		INSERT INTO DispatchList
           (DLID
           ,cDLCode
           ,cVouchType
           ,cSTCode
           ,dDate
           ,cRdCode
           ,cDepCode
           ,cPersonCode
           ,SBVID
           ,cSBVCode
           ,cSOCode
           ,cCusCode
           ,cPayCode
           ,cSCCode
           ,cShipAddress
           ,cexch_name
           ,iExchRate
           ,iTaxRate
           ,bFirst
           ,bReturnFlag
           ,bSettleAll
           ,cVerifier
           ,cMaker
           ,iNetLock
           ,iSale
           ,iVTid
           ,cBusType
           ,cCloser
           ,cAccounter
           ,cCreChpName
           ,bIAFirst
           ,ioutgolden
           ,cgatheringplan
           ,dCreditStart
           ,dGatheringDate
           ,icreditdays
           ,bCredit
           ,caddcode
           ,iverifystate
           ,ireturncount
           ,iswfcontrolled
           ,icreditstate
           ,bARFirst
           ,cmodifier
           ,dmoddate
           ,dverifydate
           ,ccusperson
           ,dcreatesystime
           ,dverifysystime
           ,dmodifysystime
           ,csvouchtype
           ,iflowid
           ,bsigncreate
           ,bcashsale
           ,cgathingcode
           ,cChanger
           ,cChangeMemo
           ,outid
           ,bmustbook
           ,cBookDepcode
           ,cBookType
           ,bSaUsed
           ,bneedbill
           ,baccswitchflag
           ,iPrintCount
           ,ccuspersoncode
           ,cSourceCode
           ,bsaleoutcreatebill
           ,cSysBarCode
           ,cCurrentAuditor
           ,csscode
           ,cinvoicecompany
           ,fEBweight
           ,cEBweightUnit
           ,cEBExpressCode
           ,iEBExpressCoID
           ,SeparateID
           ,bNotToGoldTax
           ,cEBTrnumber
           ,cEBBuyer
           ,cEBBuyerNote
           ,ccontactname
           ,cEBprovince
           ,cEBcity
           ,cEBdistrict
           ,cmobilephone
           ,cInvoiceCusName
           ,cweighter
           ,dweighttime
           ,cPickVouchCode)
     VALUES
           ((select top 1 max(maxorderid) from YDH_Max_OrderID where TableName = 'DISPATCH')
           ,#orderNum#
           ,'05'
           ,'08'
           ,CONVERT(char,#createTime#,23)
           ,NULL
           ,'34'
           ,'qx8899'
           ,0
           ,NULL
           ,#originOrderNum#
           ,#customer.code#
           ,NULL
           ,NULL
           ,NULL
           ,'人民币'
           ,1
           ,17
           ,0
           ,1
           ,0
           ,NULL
           ,'易订货'
           ,NULL
           ,0
           ,75
           ,'普通销售'
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,2
           ,NULL
           ,1
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,CONVERT(char,#createTime#,23)
           ,NULL
           ,CONVERT(char,#createTime#,23)
           ,CONVERT(char,#createTime#,23)
           ,NULL
           ,NULL
           ,0
           ,0
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,1
           ,'||SA03|'+#orderNum#
           ,NULL
           ,NULL
           ,#customer.code#
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL)
 	</insert>
 	
    <insert id="saveReturnOrderDetail" parameterClass="OrderDetail">
          INSERT INTO DispatchLists
           (DLID
           ,iCorID
           ,cWhCode
           ,cInvCode
           ,iQuantity
           ,iNum
           ,iQuotedPrice
           ,iUnitPrice
           ,iTaxUnitPrice
           ,iMoney
           ,iTax
           ,iSum
           ,iDisCount
           ,iNatUnitPrice
           ,iNatMoney
           ,iNatTax
           ,iNatSum
           ,iNatDisCount
           ,iSettleNum
           ,iSettleQuantity
           ,iBatch
           ,cBatch
           ,bSettleAll
           ,iTB
           ,dvDate
           ,TBQuantity
           ,TBNum
           ,iSOsID
           ,iDLsID
           ,KL
           ,KL2
           ,cInvName
           ,iTaxRate
           ,fOutQuantity
           ,fOutNum
           ,cItemCode
           ,cItem_class
           ,fSaleCost
           ,fSalePrice
           ,cVenAbbName
           ,cItemName
           ,cItem_CName
           ,bIsSTQc
           ,iInvExchRate
           ,cUnitID
           ,cCode
           ,iRetQuantity
           ,fEnSettleQuan
           ,fEnSettleSum
           ,iSettlePrice
           ,dMDate
           ,bGsp
           ,cGspState
           ,cSoCode
           ,cCorCode
           ,iPPartSeqID
           ,iPPartID
           ,iPPartQty
           ,cContractID
           ,cContractTagCode
           ,cContractRowGuid
           ,iMassDate
           ,cMassUnit
           ,bQANeedCheck
           ,bQAUrgency
           ,bQAChecking
           ,bQAChecked
           ,iQAQuantity
           ,iQANum
           ,cCusInvCode
           ,cCusInvName
           ,fsumsignquantity
           ,fsumsignnum
           ,cbaccounter
           ,bcosting
           ,cordercode
           ,iorderrowno
           ,fcusminprice
           ,icostquantity
           ,icostsum
           ,ispecialtype
           ,cvmivencode
           ,iexchsum
           ,imoneysum
           ,irowno
           ,frettbquantity
           ,fretsum
           ,iExpiratDateCalcu
           ,dExpirationdate
           ,cExpirationdate
           ,cbatchproperty1
           ,cbatchproperty2
           ,cbatchproperty3
           ,cbatchproperty4
           ,cbatchproperty5
           ,cbatchproperty6
           ,cbatchproperty7
           ,cbatchproperty8
           ,cbatchproperty9
           ,cbatchproperty10
           ,dblPreExchMomey
           ,dblPreMomey
           ,idemandtype
           ,cdemandcode
           ,cdemandmemo
           ,cdemandid
           ,idemandseq
           ,cvencode
           ,cReasonCode
           ,cInvSN
           ,iInvSNCount
           ,bneedsign
           ,bsignover
           ,bneedloss
           ,flossrate
           ,frlossqty
           ,fulossqty
           ,isettletype
           ,crelacuscode
           ,cLossMaker
           ,dLossDate
           ,dLossTime
           ,icoridlsid
           ,fretoutqty
           ,body_outid
           ,fVeriBillQty
           ,fVeriBillSum
           ,fVeriRetQty
           ,fVeriRetSum
           ,fLastSettleQty
           ,fLastSettleSum
           ,cBookWhcode
           ,cInVouchType
           ,cPosition
           ,fretqtywkp
           ,fretqtyykp
           ,frettbqtyykp
           ,fretsumykp
           ,dkeepdate
           ,cSCloser
           ,isaleoutid
           ,bsaleprice
           ,bgift
           ,bmpforderclosed
           ,cbSysBarCode
           ,fxjquantity
           ,fxjnum
           ,bIAcreatebill
           ,cParentCode
           ,cChildCode
           ,fchildqty
           ,fchildrate
           ,iCalcType
           ,fappretwkpqty
           ,fappretwkpsum
           ,fappretykpqty
           ,fappretykpsum
           ,fappretwkptbqty
           ,fappretykptbqty
           ,irtnappid
           ,crtnappcode
           ,fretailrealamount
           ,fretailsettleamount)
     VALUES
           ((select DLID from dispatchlist where cdlcode = #orderNum#)
           ,0
           ,'05'
           ,(select cinvcode from inventory where cinvdefine5 = #productCode#)
           ,-#count#
           ,NULL
           ,0
           ,#price#/1.17
           ,#price#
           ,-(#price#/1.17)*#count#
           ,-(0.17/1.17)*#price#*#count#
           ,-#price#*#count#
           ,0
           ,#price#/1.17
           ,-(#price#/1.17)*#count#
           ,-(0.17/1.17)*#price#*#count#
           ,-#price#*#count#
           ,0
           ,0
           ,0
           ,NULL
           ,NULL
           ,0
           ,0
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,(select top 1 max(iDLsID) from YDH_Max_OrderID where TableName = 'DISPATCH')
           ,100
           ,100
           ,(select cInvName from inventory where cinvdefine5 = #productCode#)
           ,17
           ,0
           ,0
           ,NULL
           ,NULL
           ,0
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,0
           ,0
           ,0
           ,NULL
           ,0
           ,NULL
           ,#orderNum#
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,0
           ,0
           ,0
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,0
           ,NULL
           ,1
           ,#orderNum#
           ,isnull((select max(irowno)+1  from dispatchlists where DLID = (select DLID from dispatchlist where cdlcode = #orderNum#)), 1)
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,isnull((select max(irowno)+1  from dispatchlists where DLID = (select DLID from dispatchlist where cdlcode = #orderNum#)), 1)
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
		   ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,0
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,1
           ,0
           ,NULL
           ,'||SA01|'+#orderNum#+'|' 
           ,NULL
           ,NULL
           ,1
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL
           ,NULL)
    </insert>
    
    <!-- 删除订货单 -->
    <update id="deleteOrders" parameterClass="java.util.List">
      DELETE FROM SO_SOMain WHERE csocode in
      <iterate conjunction="," open="(" close=")">
         #list[].orderNum#
      </iterate>
    </update>   
    
    <update id="deleteOrderDetails" parameterClass="java.util.List">
      DELETE FROM SO_SODetails WHERE csocode in 
	      <iterate conjunction="," open="(" close=")">
	         #list[].orderNum#	         
	      </iterate>
    </update>
		
    <!-- 删除退货单 -->
	<update id="deleteReturnOrders" parameterClass="java.util.List">
      DELETE FROM dispatchlist WHERE cdlcode in
      <iterate conjunction="," open="(" close=")">
         #list[].orderNum#
      </iterate>
    </update>   
    
    <update id="deleteReturnOrderDetails" parameterClass="java.util.List">
      DELETE FROM dispatchlists WHERE DLID in (select DLID from dispatchlist where cdlcode in
	      <iterate conjunction="," open="(" close=")">
	         #list[].orderNum#	         
	      </iterate>
	  )
    </update>
    
	<!-- 执行存储过程（插入前） -->
	<select id="excuteProcedureBeforeInsert" parameterClass="Order">
	    exec Get_YDHOrder_MaxID #orderNum#, #type#, #productTypeCount#
	</select>
	

    <resultMap id="findAllCancelOrder" class="Order">  
      <result property="orderNum" column="orderNum" javaType="java.lang.String" />  
    </resultMap>
    
    <select id="findAllCancelOrder" parameterClass="int" resultMap="findAllCancelOrder">
       
    </select>
    
</sqlMap>
